<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Downloader Pro</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        .tab-buttons button { padding: 10px 20px; cursor: pointer; border: none; background: #eee; margin-right: 5px; font-weight: bold;}
        .tab-buttons button.active { background: #007bff; color: white; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ccc; margin-top: 10px; border-radius: 5px; }
        .tab-content.active { display: block; }
        input[type="text"] { width: 70%; padding: 10px; margin-right: 10px; }
        button.action-btn { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 0; border-bottom: 1px solid #eee; }
        #loading { display: none; color: #007bff; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>Media Downloader Pro</h1>
    
    <div class="tab-buttons">
        <button class="active" onclick="showTab('audioTab', this)">Audio</button>
        <button onclick="showTab('videoTab', this)">Video</button>
        <button onclick="showTab('channelTab', this)">Channel Batch</button>
    </div>

    <div id="audioTab" class="tab-content active">
        <h3>Download Audio (MP3)</h3>
        <input type="text" id="audioUrl" placeholder="Enter Video URL (e.g., YouTube)">
        <button class="action-btn" onclick="downloadSingle('audio')">Download</button>
    </div>

    <div id="videoTab" class="tab-content">
        <h3>Download Video (MP4)</h3>
        <input type="text" id="videoUrl" placeholder="Enter Video URL">
        <button class="action-btn" onclick="downloadSingle('video')">Download</button>
    </div>

    <div id="channelTab" class="tab-content">
        <h3>Batch Download from Channel/Playlist</h3>
        <input type="text" id="channelUrl" placeholder="Enter Channel or Playlist URL">
        <button class="action-btn" onclick="fetchChannel()">Fetch Videos</button>
        <div id="loading">Processing... Please wait.</div>
        <ul id="videoList"></ul>
        <button id="batchDownloadBtn" class="action-btn" style="display:none; margin-top:20px;" onclick="downloadBatch()">Download Selected (ZIP)</button>
    </div>

    <script>
        const API_BASE = "http://localhost:8000/api";

        function showTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btnElement.classList.add('active');
        }

        // Handles Tabs 1 & 2 (Direct browser download)
        function downloadSingle(type) {
            const url = document.getElementById(`${type}Url`).value;
            if(!url) return alert("Please enter a URL");
            // Direct the browser to the file download endpoint
            window.location.href = `${API_BASE}/download/${type}?url=${encodeURIComponent(url)}`;
        }

        // Tab 3: Fetch metadata
        async function fetchChannel() {
            const url = document.getElementById('channelUrl').value;
            if(!url) return;
            
            const list = document.getElementById('videoList');
            const loading = document.getElementById('loading');
            const btn = document.getElementById('batchDownloadBtn');
            
            list.innerHTML = "";
            btn.style.display = "none";
            loading.style.display = "block";
            loading.innerText = "Fetching video list...";

            try {
                const res = await fetch(`${API_BASE}/channel-info?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                
                if(data.status === "success") {
                    data.videos.forEach(vid => {
                        list.innerHTML += `
                            <li>
                                <label>
                                    <input type="checkbox" class="batch-check" value="${vid.url}"> 
                                    ${vid.title}
                                </label>
                            </li>`;
                    });
                    btn.style.display = "block";
                } else {
                    list.innerHTML = `<li style="color:red;">Error: ${data.message}</li>`;
                }
            } catch (err) {
                list.innerHTML = `<li style="color:red;">Network Error. Is backend running?</li>`;
            }
            loading.style.display = "none";
        }

        // Tab 3: Process Batch
        async function downloadBatch() {
            const checkboxes = document.querySelectorAll('.batch-check:checked');
            const urls = Array.from(checkboxes).map(cb => cb.value);
            
            if(urls.length === 0) return alert("Select at least one video!");

            const loading = document.getElementById('loading');
            loading.style.display = "block";
            loading.innerText = "Downloading and zipping files on server... This may take a while!";

            try {
                // Because we are sending JSON data, we use POST, and handle the response as a Blob
                const res = await fetch(`${API_BASE}/download/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urls })
                });

                if(!res.ok) throw new Error("Server failed to process batch");

                const blob = await res.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = "Batch_Download.zip";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (err) {
                alert(err.message);
            }
            loading.style.display = "none";
        }
    </script>
</body>
</html>